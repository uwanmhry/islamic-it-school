<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Form Pembelian Buku</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Midtrans Snap.js -->
  <script type="text/javascript" src="https://app.sandbox.midtrans.com/snap/snap.js" data-client-key="SB-Mid-client-ZMewLn7labSKJRCZ"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-6">
  <div class="max-w-xl w-full bg-white p-8 rounded-lg shadow-lg">
    <h1 class="text-2xl font-bold text-gray-800 mb-6">Form Pembelian Buku</h1>
    
    <!-- Loading indicator untuk validasi referral -->
    <div id="refValidationLoading" class="mb-6 p-4 bg-yellow-50 rounded-lg border border-yellow-200 hidden">
      <p class="text-sm text-yellow-700">üîÑ Memvalidasi kode referral...</p>
    </div>
    
    <!-- Informasi Buku -->
    <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
      <h2 class="text-lg font-semibold text-blue-800 mb-2">Detail Buku</h2>
      <p class="text-sm text-blue-700"><strong>Judul:</strong> <span id="judulDisplay">-</span></p>
      <p class="text-sm text-blue-700"><strong>Harga Asli:</strong> Rp <span id="hargaAsliDisplay">0</span></p>
      <p class="text-sm text-blue-700"><strong>Kode Referral:</strong> <span id="refDisplay">-</span></p>
      
      <div id="diskonInfo" class="mt-2 p-2 bg-green-100 text-green-700 text-sm rounded hidden">
        ‚úÖ Diskon 5% dari kode referral telah diterapkan!
      </div>
      
      <div id="refErrorInfo" class="mt-2 p-2 bg-red-100 text-red-700 text-sm rounded hidden">
        ‚ùå Kode referral tidak valid atau tidak ditemukan
      </div>
      
      <div id="hargaFinal" class="mt-2 text-lg font-bold text-blue-800">
        <strong>Total Bayar: Rp <span id="hargaFinalDisplay">0</span></strong>
      </div>
    </div>

    <form id="purchaseForm" class="space-y-5">
      <!-- Hidden fields untuk data buku -->
      <input type="hidden" id="book_title" name="book_title">
      <input type="hidden" id="price" name="price">
      <input type="hidden" id="referral_code" name="referral_code">
      <input type="hidden" id="is_referral_valid" name="is_referral_valid" value="false">

      <div>
        <label for="nama_pembeli" class="block text-sm font-semibold text-gray-700 mb-2">
          Nama Pembeli *
        </label>
        <input type="text" id="nama_pembeli" name="nama_pembeli" required
          placeholder="Masukkan nama lengkap"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
      </div>

      <div>
        <label for="alamat" class="block text-sm font-semibold text-gray-700 mb-2">
          Alamat Lengkap *
        </label>
        <textarea id="alamat" name="alamat" required rows="3"
          placeholder="Masukkan alamat lengkap untuk pengiriman"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 resize-none"></textarea>
      </div>

      <div>
        <label for="nomor_pembeli" class="block text-sm font-semibold text-gray-700 mb-2">
          Nomor HP/WhatsApp *
        </label>
        <input type="tel" id="nomor_pembeli" name="nomor_pembeli" required
          placeholder="Contoh: 08123456789"
          pattern="[0-9+\-\s]+"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
      </div>

      <div>
        <label for="customer_email" class="block text-sm font-semibold text-gray-700 mb-2">
          Email (Opsional)
        </label>
        <input type="email" id="customer_email" name="customer_email"
          placeholder="contoh@email.com"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
      </div>

      <!-- Info Pembayaran -->
      <div class="p-4 bg-green-50 rounded-lg border border-green-200">
        <h3 class="text-sm font-semibold text-green-800 mb-2">üí≥ Metode Pembayaran</h3>
        <p class="text-sm text-green-700">
          Setelah klik "Bayar Sekarang", Anda akan dapat memilih metode pembayaran:
        </p>
        <ul class="text-xs text-green-600 mt-2 space-y-1">
          <li>‚Ä¢ Kartu Kredit/Debit</li>
          <li>‚Ä¢ Bank Transfer (BCA, BNI, BRI, Mandiri)</li>
          <li>‚Ä¢ E-Wallet (GoPay, OVO, DANA, ShopeePay)</li>
          <li>‚Ä¢ QRIS & Virtual Account</li>
        </ul>
      </div>

      <button type="submit" id="submitBtn"
        class="w-full py-3 px-6 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition duration-200 font-semibold">
        <span id="submitText">Bayar Sekarang</span>
        <span id="loadingText" class="hidden">Memproses...</span>
      </button>
    </form>

    <div id="resultMessage" class="mt-4 text-center text-sm hidden"></div>
    
    <!-- Info tambahan -->
    <div class="mt-6 text-xs text-gray-500 text-center">
      <p>Dengan melakukan pembelian, Anda menyetujui syarat dan ketentuan yang berlaku.</p>
      <p class="mt-1">Pembayaran diproses dengan aman melalui Midtrans</p>
    </div>
  </div>

<script>
// Ambil parameter dari URL
const urlParams = new URLSearchParams(window.location.search);
const bookTitle = urlParams.get('book_title') || 'Judul Buku Tidak Tersedia';
const price = parseFloat(urlParams.get('price')) || 0;
const ref = urlParams.get('ref') || '';

// State untuk validasi referral
let isReferralValid = false;
let referralValidated = false;

// Validasi parameter
if (!bookTitle || price <= 0) {
  document.body.innerHTML = `
    <div class="min-h-screen flex items-center justify-center p-6">
      <div class="max-w-md bg-white p-8 rounded-lg shadow-lg text-center">
        <h1 class="text-xl font-bold text-red-600 mb-4">Error</h1>
        <p class="text-gray-600">Parameter buku tidak valid. Silakan kembali ke halaman sebelumnya.</p>
        <button onclick="window.history.back()" class="mt-4 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
          Kembali
        </button>
      </div>
    </div>
  `;
} else {
  // Isi hidden fields
  document.getElementById('book_title').value = bookTitle;
  document.getElementById('price').value = price;
  document.getElementById('referral_code').value = ref;

  // Tampilkan informasi buku awal
  document.getElementById('judulDisplay').textContent = bookTitle;
  document.getElementById('hargaAsliDisplay').textContent = price.toLocaleString('id-ID');
  document.getElementById('refDisplay').textContent = (ref && ref !== 'NO_REF') ? ref : '-';
  
  // Jika ada kode referral, validasi dulu
  if (ref && ref.trim() !== '' && ref !== 'NO_REF') {
    validateReferralCode(ref);
  } else {
    // Tidak ada referral, langsung tampilkan harga normal
    updatePriceDisplay(price, false);
    referralValidated = true;
  }
}

// Fungsi untuk memvalidasi kode referral dengan database
async function validateReferralCode(refCode) {
  const loadingElement = document.getElementById('refValidationLoading');
  const diskonInfo = document.getElementById('diskonInfo');
  const refErrorInfo = document.getElementById('refErrorInfo');
  
  try {
    // Tampilkan loading
    loadingElement.classList.remove('hidden');
    diskonInfo.classList.add('hidden');
    refErrorInfo.classList.add('hidden');
    
    const response = await fetch('http://localhost:5000/api/referal', {
      method: 'GET',
      headers: {
        'Accept': 'application/json'
      }
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const referralCodes = await response.json();
    
    // Cek apakah kode referral ada di database
    const validReferral = referralCodes.find(item => 
      item.kode_referal === refCode
    );

    if (validReferral) {
      isReferralValid = true;
      document.getElementById('is_referral_valid').value = 'true';
      diskonInfo.classList.remove('hidden');
      updatePriceDisplay(price, true);
    } else {
      isReferralValid = false;
      document.getElementById('is_referral_valid').value = 'false';
      refErrorInfo.classList.remove('hidden');
      updatePriceDisplay(price, false);
    }
    
  } catch (error) {
    console.error('Error validating referral code:', error);
    isReferralValid = false;
    document.getElementById('is_referral_valid').value = 'false';
    refErrorInfo.classList.remove('hidden');
    updatePriceDisplay(price, false);
    
    // Tampilkan pesan error jika gagal koneksi ke server
    showMessage('‚ö†Ô∏è Gagal memvalidasi kode referral. Pembelian akan dilanjutkan tanpa diskon.', 'warning');
  } finally {
    loadingElement.classList.add('hidden');
    referralValidated = true;
  }
}

// Fungsi untuk update tampilan harga
function updatePriceDisplay(originalPrice, hasValidDiscount) {
  const finalPrice = hasValidDiscount ? Math.round(originalPrice * 0.95) : originalPrice;
  
  document.getElementById('hargaFinalDisplay').textContent = finalPrice.toLocaleString('id-ID');
  
  const hargaFinalElement = document.getElementById('hargaFinal');
  if (hasValidDiscount) {
    hargaFinalElement.classList.add('text-green-600');
    hargaFinalElement.classList.remove('text-blue-800');
  } else {
    hargaFinalElement.classList.remove('text-green-600');
    hargaFinalElement.classList.add('text-blue-800');
  }
}

// Fungsi untuk menambah usage referral code
async function incrementReferralUsage(refCode) {
  try {
    const response = await fetch(`http://localhost:5000/api/referal/use/${refCode}`, {
      method: 'PUT',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      }
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const result = await response.json();
    console.log('Referral usage incremented:', result.message);
    
  } catch (error) {
    console.error('Error incrementing referral usage:', error);
    // Jangan hentikan proses pembelian jika gagal update usage
  }
}

// Handle form submission
document.getElementById('purchaseForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  // Pastikan validasi referral sudah selesai
  if (!referralValidated) {
    showMessage('Menunggu validasi kode referral...', 'warning');
    return;
  }
  
  const submitBtn = document.getElementById('submitBtn');
  const submitText = document.getElementById('submitText');
  const loadingText = document.getElementById('loadingText');
  const resultMessage = document.getElementById('resultMessage');
  
  // Disable button dan tampilkan loading
  submitBtn.disabled = true;
  submitText.classList.add('hidden');
  loadingText.classList.remove('hidden');
  resultMessage.classList.add('hidden');

  const formData = new FormData(e.target);
  
  // Validasi form
  const nama = formData.get('nama_pembeli').trim();
  const alamat = formData.get('alamat').trim();
  const nomor = formData.get('nomor_pembeli').trim();
  const customerEmail = formData.get('customer_email') ? formData.get('customer_email').trim() : '';
  
  if (!nama || !alamat || !nomor) {
    showMessage('Harap isi semua field yang wajib!', 'error');
    resetButton();
    return;
  }

  // Validasi nomor telepon
  if (!/^[0-9+\-\s]{10,15}$/.test(nomor)) {
    showMessage('Format nomor telepon tidak valid!', 'error');
    resetButton();
    return;
  }

  // Validasi email jika diisi
  if (customerEmail && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(customerEmail)) {
    showMessage('Format email tidak valid!', 'error');
    resetButton();
    return;
  }

  const originalPrice = parseFloat(formData.get('price'));
  const referralCode = formData.get('referral_code') || '';
  const isValidReferral = formData.get('is_referral_valid') === 'true';
  
  // Hitung harga final berdasarkan validasi referral
  let finalPrice = originalPrice;
  if (isValidReferral && referralCode.trim() !== '' && referralCode !== 'NO_REF') {
    finalPrice = Math.round(originalPrice * 0.95); // Diskon 5%
  }


  // ‚úÖ PERBAIKAN: Data untuk log-click tanpa order_id dulu
  const logData = {

    book_title: formData.get('book_title'),
    referral_code: referralCode,
    is_referral_valid: isValidReferral,
    user_agent: navigator.userAgent,
    nama_pembeli: nama,
    alamat: alamat,
    nomor_pembeli: nomor,
    harga: finalPrice,
    harga_asli: originalPrice,
    diskon_amount: originalPrice - finalPrice,
    timestamp: new Date().toISOString()

  };

  try {
    // Log ke database dulu
    const response = await fetch('http://localhost:5000/api/log-click', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },

      body: JSON.stringify(logData)

    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const result = await response.json();
    
    if (result.success !== false) {

      // Update referral usage jika valid
      if (isValidReferral && referralCode.trim() !== '' && referralCode !== 'NO_REF') {
        await incrementReferralUsage(referralCode);
      }

      // Buat transaksi Midtrans menggunakan Snap Preference
      try {
        const midtransResponse = await fetch('http://localhost:5000/api/midtrans/create-transaction', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            nama: nama,
            nomor: nomor,
            alamat: alamat,
            amount: finalPrice,
            item_name: formData.get('book_title'),
            referral_code: referralCode,
            customer_email: customerEmail,

            log_id: result.id || result.insertId // ‚úÖ Gunakan ID dari response log

          })
        });

        if (!midtransResponse.ok) {
          const errorData = await midtransResponse.json();
          console.error('Midtrans Error Response:', errorData);
          throw new Error(`Midtrans Error: ${errorData.message || midtransResponse.status}`);
        }

        const midtransResult = await midtransResponse.json();

        if (midtransResult.success && midtransResult.token) {
          // Reset button sebelum buka Snap
          resetButton();
          
          // Buka Midtrans Snap popup
          window.snap.pay(midtransResult.token, {
            onSuccess: function(result) {
              console.log('Payment success:', result);
              showMessage('‚úÖ Pembayaran berhasil! Terima kasih atas pembelian Anda.', 'success');
              
              // Optional: redirect ke halaman sukses setelah beberapa detik
              setTimeout(() => {
                window.location.href = '/payment-success.html?order_id=' + midtransResult.order_id;
              }, 3000);
            },
            onPending: function(result) {
              console.log('Payment pending:', result);
              showMessage('‚è≥ Pembayaran pending. Silakan selesaikan pembayaran Anda.', 'warning');
            },
            onError: function(result) {
              console.log('Payment error:', result);
              showMessage('‚ùå Terjadi kesalahan saat memproses pembayaran.', 'error');
            },
            onClose: function() {
              console.log('Payment popup closed');
              showMessage('‚ÑπÔ∏è Pembayaran dibatalkan atau ditutup.', 'warning');
            }
          });

        } else {
          showMessage('‚ùå Gagal membuat transaksi pembayaran: ' + (midtransResult.message || 'Unknown error'), 'error');
        }

      } catch (midtransErr) {
        console.error('Midtrans Error:', midtransErr);
        showMessage('‚ùå Terjadi kesalahan saat menghubungkan ke sistem pembayaran: ' + midtransErr.message, 'error');
      }
    } else {
      showMessage('‚ùå Gagal menyimpan data pembelian.', 'error');
    }
    
  } catch (error) {
    console.error('Error:', error);
    
    if (error.name === 'TypeError' && error.message.includes('fetch')) {
      showMessage('‚ö†Ô∏è Tidak dapat terhubung ke server. Periksa koneksi internet Anda.', 'error');
    } else {
      showMessage('‚ùå Terjadi kesalahan sistem. Silakan coba lagi.', 'error');
    }
  } finally {
    resetButton();
  }
});

function showMessage(message, type) {
  const resultMessage = document.getElementById('resultMessage');
  resultMessage.textContent = message;
  
  let colorClass;
  switch(type) {
    case 'success':
      colorClass = 'text-green-700 bg-green-100 border border-green-300';
      break;
    case 'warning':
      colorClass = 'text-yellow-700 bg-yellow-100 border border-yellow-300';
      break;
    case 'error':
    default:
      colorClass = 'text-red-700 bg-red-100 border border-red-300';
      break;
  }
  
  resultMessage.className = `mt-4 text-sm text-center p-3 rounded-lg ${colorClass}`;
  resultMessage.classList.remove('hidden');
}

function resetButton() {
  const submitBtn = document.getElementById('submitBtn');
  const submitText = document.getElementById('submitText');
  const loadingText = document.getElementById('loadingText');
  
  submitBtn.disabled = false;
  submitText.classList.remove('hidden');
  loadingText.classList.add('hidden');
}

// Validasi real-time untuk nomor telepon
document.getElementById('nomor_pembeli').addEventListener('input', function(e) {
  const value = e.target.value;
  const isValid = /^[0-9+\-\s]*$/.test(value);
  
  if (!isValid) {
    e.target.setCustomValidity('Hanya boleh menggunakan angka, +, -, dan spasi');
  } else {
    e.target.setCustomValidity('');
  }
});

// Validasi real-time untuk email
document.getElementById('customer_email').addEventListener('input', function(e) {
  const value = e.target.value;
  if (value && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
    e.target.setCustomValidity('Format email tidak valid');
  } else {
    e.target.setCustomValidity('');
  }
});

// Handle jika Snap.js gagal dimuat
window.addEventListener('load', function() {
  if (typeof window.snap === 'undefined') {
    console.error('Midtrans Snap.js failed to load');
    showMessage('‚ùå Gagal memuat sistem pembayaran. Silakan refresh halaman.', 'error');
  }
});
</script>
</body>
</html>